# Cloud Build configuration for AgentWorks
# This file is auto-generated by Terraform

steps:
  # Install dependencies
  - name: 'node:18-alpine'
    id: 'install-deps'
    entrypoint: 'sh'
    args:
      - '-c'
      - |
        npm install -g pnpm@9.14.2
        pnpm install --frozen-lockfile
    volumes:
      - name: 'workspace'
        path: '/workspace'

  # Type checking
  - name: 'node:18-alpine'
    id: 'typecheck'
    entrypoint: 'sh'
    args:
      - '-c'
      - |
        pnpm typecheck
    volumes:
      - name: 'workspace'
        path: '/workspace'
    waitFor: ['install-deps']

  # Linting
  - name: 'node:18-alpine'
    id: 'lint'
    entrypoint: 'sh'
    args:
      - '-c'
      - |
        pnpm lint
    volumes:
      - name: 'workspace'
        path: '/workspace'
    waitFor: ['install-deps']

  # Run tests
  - name: 'node:18-alpine'
    id: 'test'
    entrypoint: 'sh'
    args:
      - '-c'
      - |
        pnpm test
    volumes:
      - name: 'workspace'
        path: '/workspace'
    waitFor: ['typecheck', 'lint']

  # Build applications
  - name: 'node:18-alpine'
    id: 'build'
    entrypoint: 'sh'
    args:
      - '-c'
      - |
        pnpm build
    volumes:
      - name: 'workspace'
        path: '/workspace'
    waitFor: ['test']

%{ for service in services ~}
  # Build ${service} Docker image
  - name: 'gcr.io/cloud-builders/docker'
    id: 'build-${service}'
    args:
      - 'build'
      - '-t'
      - '${region}-docker.pkg.dev/${project_id}/${artifact_registry}/${service}:$SHORT_SHA'
      - '-t'
      - '${region}-docker.pkg.dev/${project_id}/${artifact_registry}/${service}:latest'
      - '-f'
      - 'apps/${service == "api-gateway" ? "api" : service}/Dockerfile'
      - '.'
    waitFor: ['build']

  # Push ${service} Docker image
  - name: 'gcr.io/cloud-builders/docker'
    id: 'push-${service}'
    args:
      - 'push'
      - '--all-tags'
      - '${region}-docker.pkg.dev/${project_id}/${artifact_registry}/${service}'
    waitFor: ['build-${service}']

%{ endfor ~}

  # Deploy to Cloud Run (only if not a test build)
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-services'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        if [ "$${_SKIP_DEPLOY:-false}" = "true" ]; then
          echo "Skipping deployment (test build)"
          exit 0
        fi
        
        # Configure gcloud
        gcloud config set project ${project_id}
        gcloud config set run/region ${region}
        
        # Deploy each service
%{ for service in services ~}
        echo "Deploying ${service}..."
        gcloud run deploy ${service} \
          --image=${region}-docker.pkg.dev/${project_id}/${artifact_registry}/${service}:$SHORT_SHA \
          --region=${region} \
          --service-account=$${_SERVICE_ACCOUNT} \
          --no-allow-unauthenticated \
          --max-instances=10 \
          --memory=1Gi \
          --cpu=1 \
          --concurrency=100 \
          --timeout=300 \
          --port=$${${service == "frontend" ? "3000" : service == "api-gateway" ? "8080" : "8000"}} \
          --set-env-vars="ENVIRONMENT=$${_ENVIRONMENT},PROJECT_ID=${project_id},REGION=${region}" \
          --quiet
        
%{ endfor ~}
        
        echo "All services deployed successfully!"
    waitFor: [%{ for service in services ~}'push-${service}'%{ if service != services[length(services)-1] }, %{ endif }%{ endfor ~}]

  # Database migrations (if needed)
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'migrate-database'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        if [ "$${_SKIP_DEPLOY:-false}" = "true" ]; then
          echo "Skipping database migration (test build)"
          exit 0
        fi
        
        if [ "$${_ENVIRONMENT}" = "prod" ] && [ "$${_MANUAL_TRIGGER:-false}" != "true" ]; then
          echo "Skipping automatic database migration in production"
          echo "Run migrations manually after deployment verification"
          exit 0
        fi
        
        echo "Running database migrations for $${_ENVIRONMENT}..."
        
        # Install dependencies in migration container
        npm install -g pnpm@9.14.2
        pnpm install --frozen-lockfile
        
        # Run migrations
        pnpm --filter @agentworks/db migrate
        
        echo "Database migrations completed!"
    volumes:
      - name: 'workspace'
        path: '/workspace'
    waitFor: ['deploy-services']

  # Health check deployment
  - name: 'gcr.io/cloud-builders/curl'
    id: 'health-check'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        if [ "$${_SKIP_DEPLOY:-false}" = "true" ]; then
          echo "Skipping health check (test build)"
          exit 0
        fi
        
        echo "Performing health checks..."
        
        # Wait for services to be ready
        sleep 30
        
        # Get service URLs
        API_URL=$(gcloud run services describe api-gateway --region=${region} --format='value(status.url)')
        FRONTEND_URL=$(gcloud run services describe frontend --region=${region} --format='value(status.url)')
        
        # Check API health
        echo "Checking API health at $API_URL/health"
        curl -f "$API_URL/health" || exit 1
        
        # Check frontend health  
        echo "Checking frontend health at $FRONTEND_URL/api/health"
        curl -f "$FRONTEND_URL/api/health" || exit 1
        
        echo "All health checks passed!"
    waitFor: ['migrate-database']

# Build options
options:
  # Use larger machine type for faster builds
  machineType: 'E2_HIGHCPU_8'
  
  # Disk size
  diskSizeGb: 100
  
  # Enable build logs streaming
  logging: CLOUD_LOGGING_ONLY
  
  # Use workspace volume for better performance
  volumes:
    - name: 'workspace'
      path: '/workspace'
  
  # Environment variables
  env:
    - 'DOCKER_BUILDKIT=1'
    - 'BUILDKIT_PROGRESS=plain'

# Substitutions (default values)
substitutions:
  _ENVIRONMENT: 'dev'
  _SKIP_DEPLOY: 'false'
  _MANUAL_TRIGGER: 'false'
  _SERVICE_ACCOUNT: ''

# Build timeout (20 minutes)
timeout: '1200s'

# Available logs
availableSecrets:
  secretManager:
    - versionName: projects/${project_id}/secrets/database-url/versions/latest
      env: 'DATABASE_URL'
    - versionName: projects/${project_id}/secrets/openai-api-key/versions/latest
      env: 'OPENAI_API_KEY'
    - versionName: projects/${project_id}/secrets/anthropic-api-key/versions/latest
      env: 'ANTHROPIC_API_KEY'

# Tags for build tracking
tags:
  - 'agentworks'
  - '${artifact_registry}'
  - '$${_ENVIRONMENT}'